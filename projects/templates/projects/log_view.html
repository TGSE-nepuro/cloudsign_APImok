{% extends 'base.html' %}

{% block title %}アプリケーションログ{% endblock %}

{% block extra_head %}
<style>
    .log-row-api {
        border-left: 5px solid #0d6efd; /* Bootstrap's primary blue */
    }
    .table-sm th, .table-sm td {
        padding: 0.4rem;
        vertical-align: top;
    }
</style>
{% endblock %}


{% block content %}
    <h1 class="mb-4">アプリケーションログ</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">ログフィルタリング</h5>
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="id_level" class="form-label visually-hidden">レベル</label>
                    <select name="level" id="id_level" class="form-select">
                        <option value="">全てのレベル</option>
                        <option value="情報" {% if request_get.level == '情報' %}selected{% endif %}>情報</option>
                        <option value="警告" {% if request_get.level == '警告' %}selected{% endif %}>警告</option>
                        <option value="エラー" {% if request_get.level == 'エラー' %}selected{% endif %}>エラー</option>
                        <option value="緊急" {% if request_get.level == '緊急' %}selected{% endif %}>緊急</option>
                        <option value="デバッグ" {% if request_get.level == 'デバッグ' %}selected{% endif %}>デバッグ</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="id_search" class="form-label visually-hidden">検索キーワード</label>
                    <input type="text" name="search" id="id_search" class="form-control" placeholder="メッセージ、ロガー名、操作名で検索" value="{{ request_get.search }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">フィルター</button>
                </div>
                <div class="col-md-2">
                    <a href="{% url 'projects:log_view' %}" class="btn btn-outline-secondary">クリア</a>
                </div>
            </form>
        </div>
    </div>


    <div class="card">
        <div class="card-header">
            最近のログエントリ
        </div>
        <div class="card-body">
            {% if not log_file_exists %}
                <p>ログファイル (<code>{{ settings.LOG_DIR }}/debug.log</code>) が見つかりません。</p>
            {% elif log_entries %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 8%;">レベル</th>
                                <th style="width: 14%;">日時</th>
                                <th style="width: 12%;">ロガー名</th>
                                <th style="width: 8%;">種別</th>
                                <th style="width: 12%;">操作</th>
                                <th style="width: 10%;">関連案件</th>
                                <th style="width: 36%;">メッセージ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in log_entries %}
                                <tr class="{{ entry.level_class }} {% if entry.log_type == 'API' %}log-row-api{% endif %}">
                                    <td>
                                        <span class="badge 
                                            {% if entry.level == 'エラー' or entry.level == '緊急' %}bg-danger
                                            {% elif entry.level == '警告' %}bg-warning text-dark
                                            {% elif entry.level == '情報' %}bg-info text-dark
                                            {% elif entry.level == 'デバッグ' %}bg-secondary
                                            {% else %}bg-dark
                                            {% endif %}">{{ entry.level }}</span>
                                    </td>
                                    <td>{{ entry.datetime }}</td>
                                    <td>{{ entry.logger_name }}</td>
                                    <td>
                                        <span class="badge {% if entry.log_type == 'API' %}bg-primary{% else %}bg-light text-dark border{% endif %}">
                                            {{ entry.log_type }}
                                        </span>
                                    </td>
                                    <td>{{ entry.operation|default:"N/A" }}</td>
                                    <td>
                                        {% if entry.project_url %}
                                            <a href="{{ entry.project_url }}" class="btn btn-sm btn-outline-primary">
                                                ID: {{ entry.project_id }}
                                            </a>
                                        {% else %}
                                            {{ entry.project_id|default:"N/A" }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <pre style="white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0; font-size: 0.875em;">{{ entry.message }}</pre>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>条件に一致するログエントリがありません。</p>
            {% endif %}
        </div>
    </div>
    <a href="{% url 'projects:project_list' %}" class="btn btn-secondary mt-3">案件一覧に戻る</a>
{% endblock %}