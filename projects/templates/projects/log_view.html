{% extends 'base.html' %}

{% block title %}アプリケーションログ{% endblock %}

{% block content %}
    <h1 class="mb-4">アプリケーションログ</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">ログフィルタリング</h5>
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="id_level" class="form-label visually-hidden">レベル</label>
                    <select name="level" id="id_level" class="form-select">
                        <option value="">全てのレベル</option>
                        <option value="情報" {% if request_get.level == '情報' %}selected{% endif %}>情報</option>
                        <option value="警告" {% if request_get.level == '警告' %}selected{% endif %}>警告</option>
                        <option value="エラー" {% if request_get.level == 'エラー' %}selected{% endif %}>エラー</option>
                        <option value="緊急" {% if request_get.level == '緊急' %}selected{% endif %}>緊急</option>
                        <option value="デバッグ" {% if request_get.level == 'デバッグ' %}selected{% endif %}>デバッグ</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="id_search" class="form-label visually-hidden">検索キーワード</label>
                    <input type="text" name="search" id="id_search" class="form-control" placeholder="メッセージまたはモジュールで検索" value="{{ request_get.search }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">フィルター</button>
                </div>
                <div class="col-md-2">
                    <a href="{% url 'projects:log_view' %}" class="btn btn-outline-secondary">クリア</a>
                </div>
            </form>
        </div>
    </div>


    <div class="card">
        <div class="card-header">
            最近のログエントリ
        </div>
        <div class="card-body">
            {% if not log_file_exists %}
                <p>ログファイル (<code>{{ settings.LOG_DIR }}/debug.log</code>) が見つかりません。</p>
            {% elif log_entries %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 10%;">レベル</th>
                                <th style="width: 15%;">日時</th>
                                <th style="width: 15%;">発生元</th>
                                <th style="width: 60%;">メッセージ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in log_entries %}
                                <tr class="{{ entry.level_class }}">
                                    <td>
                                        {% if entry.level == 'エラー' %}
                                            <span class="badge bg-danger">{{ entry.level }}</span>
                                        {% elif entry.level == '警告' %}
                                            <span class="badge bg-warning">{{ entry.level }}</span>
                                        {% elif entry.level == '情報' %}
                                            <span class="badge bg-info">{{ entry.level }}</span>
                                        {% elif entry.level == 'デバッグ' %}
                                            <span class="badge bg-secondary">{{ entry.level }}</span>
                                        {% else %}
                                            <span class="badge bg-dark">{{ entry.level }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ entry.datetime }}</td>
                                    <td>{{ entry.module }}</td>
                                    <td>
                                        <pre style="white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0;">{{ entry.message }}</pre>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>条件に一致するログエントリがありません。</p>
            {% endif %}
        </div>
    </div>
    <a href="{% url 'projects:project_list' %}" class="btn btn-secondary mt-3">案件一覧に戻る</a>
{% endblock %}