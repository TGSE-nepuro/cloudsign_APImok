{% extends 'base.html' %}

{% block title %}案件詳細 - {{ project.title }}{% endblock %}

{% block content %}
    <h1>案件詳細</h1>
    <div class="card">
        <div class="card-header">
            {{ project.title }}
        </div>
        <div class="card-body">
            <h5 class="card-title">説明:</h5>
            <p class="card-text">{{ project.description|default:"説明なし" }}</p>
            <h5 class="card-title">取引先情報:</h5>
            <p class="card-text">{{ project.customer_info|default:"未設定" }}</p>
            <h5 class="card-title">期日:</h5>
            <p class="card-text">{{ project.due_date|default:"未設定" }}</p>
            <h5 class="card-title">金額:</h5>
            <p class="card-text">{{ project.amount|default:"未設定" }}</p>
            <h5 class="card-title">CloudSign Document ID:</h5>
            <p class="card-text">{{ project.cloudsign_document_id|default:"未設定" }}</p>
            {% if project.send_method %}
                <h5 class="card-title">送信種別:</h5>
                <p class="card-text">{{ project.get_send_method_display }}</p>
            {% endif %}

            {% if files %}
                <h5 class="card-title">送信PDFファイル:</h5>
                <ul class="list-group mb-3">
                    {% for f in files %}
                        <li class="list-group-item">
                            {{ f.original_name|default:f.file.name|truncatechars:80 }}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if cloudsign_status %}
                <h5 class="card-title">CloudSign ステータス:</h5>
                <p class="card-text">{{ cloudsign_status }}</p>
            {% endif %}

            {% if cloudsign_participants %}
                <h5 class="card-title">CloudSign 参加者:</h5>
                <ul class="list-group mb-3">
                    {% for participant in cloudsign_participants %}
                        <li class="list-group-item">
                            {{ participant.name }}
                            {% if participant.tel %}（{{ participant.tel }}）{% endif %}
                            {% if participant.email %} ({{ participant.email }}){% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                {% if project.cloudsign_document_id %}
                    <p class="card-text">参加者はまだ追加されていません。</p>
                {% endif %}
            {% endif %}

            {# Add buttons for embedded signing for local participants #}
            {% if project.cloudsign_document_id and project.participants.all %}
                <h5 class="card-title mt-3">組込み署名リンク:</h5>
                <ul class="list-group mb-3">
                    {% for local_participant in project.participants.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ local_participant.name }} ({{ local_participant.email }})
                            {% if local_participant.signing_url %}
                                <a href="{% url 'projects:signing_view' signer_id=local_participant.id %}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-info">署名ページへ</a>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            <p class="card-text"><small class="text-muted">作成日時: {{ project.created_at|date:"Y/m/d H:i" }}</small></p>
            <p class="card-text"><small class="text-muted">更新日時: {{ project.updated_at|date:"Y/m/d H:i" }}</small></p>
            <a href="{% url 'projects:project_manage_edit' project.pk %}" class="btn btn-warning">編集</a>
            <a href="{% url 'projects:project_delete' project.pk %}" class="btn btn-danger">削除</a>
            <a href="{% url 'projects:project_list' %}" class="btn btn-secondary">一覧に戻る</a>
            {% if project.cloudsign_document_id %}
                <a href="{% url 'projects:project_detail' project.pk %}" class="btn btn-info" style="margin-left: 5px;">ステータスを更新</a>
                {% if cloudsign_status == "締結済" %}
                    <a href="{% url 'projects:download_document' project.pk %}" class="btn btn-primary" style="margin-left: 5px;">契約書を取得</a>
                {% endif %}
            {% endif %}

            {% if project.cloudsign_document_id and project.participants.exists and project.send_method == 'embedded_sms' %}
                <hr>
                <h5 class="card-title">同意用マイページ</h5>
                <p class="text-muted">受信者に案内する際は、対象宛先のリンクを使用してください。</p>
                <ul class="list-group">
                    {% for participant in project.participants.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                {{ participant.name }}
                                {% if participant.tel %}（{{ participant.tel }}）{% endif %}
                                {% if participant.cloudsign_participant_id %}（ID取得済み）{% else %}（ID未取得）{% endif %}
                            </span>
                            {% if participant.cloudsign_participant_id %}
                                <a class="btn btn-sm btn-outline-primary" href="{% url 'projects:consent_mypage' %}?document_id={{ project.cloudsign_document_id }}&participant_id={{ participant.cloudsign_participant_id }}&local_participant_id={{ participant.id }}">同意用マイページ</a>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    </div>
{% endblock %}
